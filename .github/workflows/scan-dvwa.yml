name: Static Scan

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  scan:
    runs-on: ubuntu-latest

    env:
      QODO_API_KEY: ${{ secrets.QODO_APIKEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip npm git
          pip install --upgrade pip

      # -----------------------------
      # Install Qodo CLI
      # -----------------------------
      - name: Install Qodo CLI
        run: |
          npm install -g @qodo/command
          qodo --help || true

      # -----------------------------
      # Install ARM Metis
      # -----------------------------
      - name: Install Metis CLI
        run: |
          git clone https://github.com/arm/metis.git
          cd metis
          pip install -r requirements.txt --user
          pip install . --user
          cd ..
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          which metis || true

      # -----------------------------
      # Run Qodo scan
      # -----------------------------
      - name: Run Qodo Scan
        run: |
          echo "Running Qodo..."
          qodo scan . \
            --format json \
            --output qodo.json \
            --ci \
            || true

          echo "Qodo scan output:"
          cat qodo.json || echo "No qodo.json found"

      # -----------------------------
      # Run Metis scan
      # -----------------------------
      - name: Run Metis Scan
        run: |
          echo "Running Metis..."
          metis \
            --non-interactive \
            --command "review_code" \
            --codebase-path "." \
            --output-file "metis.json" \
            || true

          echo "Metis scan output:"
          cat metis.json || echo "No metis.json found"

      # -----------------------------
      # Normalize JSON files
      # -----------------------------
      - name: Normalize JSON
        run: |
          jq -S . qodo.json  > qodo-sorted.json  || echo "{}" > qodo-sorted.json
          jq -S . metis.json > metis-sorted.json || echo "{}" > metis-sorted.json

      # -----------------------------
      # Diff Output
      # -----------------------------
      - name: Compare Results
        run: |
          echo "======== DIFF ========"
          diff -u qodo-sorted.json metis-sorted.json || true
          echo "========================"

      # -----------------------------
      # Upload artifacts
      # -----------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            qodo.json
            metis.json
            qodo-sorted.json
            metis-sorted.json
