name: DVWA Full Scan

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  full-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Qodo install
      - name: Install Qodo
        run: |
          echo "Installing Qodo CLI..."
          # Replace placeholder
          echo "Qodo installed."

      # Metis install
      - name: Install Metis
        run: |
          echo "Installing Metis CLI..."
          # Replace placeholder
          echo "Metis installed."

      - name: Start DVWA
        working-directory: dvwa
        run: docker compose up -d

      - name: Wait for DVWA
        run: |
          for i in {1..40}; do
            if curl -s http://127.0.0.1:4280 | grep -qi "DVWA"; then
              echo "DVWA is UP!"
              exit 0
            fi
            echo "Waiting..."
            sleep 5
          done
          echo "DVWA failed to start"
          exit 1

      - name: Run Qodo Scan
        run: |
          qodo scan http://127.0.0.1:4280 --format json --output qodo.json || true

      - name: Run Metis Scan
        run: |
          metis scan --url http://127.0.0.1:4280 --json > metis.json || true


      # ------------------------------
      # Normalize JSON
      # ------------------------------
      - name: Normalize outputs
        run: |
          jq -S . qodo.json > qodo-sorted.json || true
          jq -S . metis.json > metis-sorted.json || true

      # ------------------------------
      # Print DIFF (visible in logs)
      # ------------------------------
      - name: Compare Results
        run: |
          echo "===== DIFF ====="
          diff qodo-sorted.json metis-sorted.json || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dvwa-scan-results
          path: |
            qodo.json
            metis.json
            qodo-sorted.json
            metis-sorted.json
