name: Static Scan

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq python3-pip
          pip install --upgrade pip

      # -------------------------
      # Install Qodo (NPM CLI)
      # -------------------------
      - name: Install Qodo CLI
        run: |
          npm install -g @qodo/command
          qodo --help || true

      # -------------------------
      # Install Metis
      # (Assuming Metis CLI is `npm install -g @metis/command`
      #  or pip install metisai â€” you need to confirm)
      # -------------------------
      - name: Install Metis CLI
        run: |
          pip install metisai
          metis --help || true

      # -------------------------
      # Run static scans
      # -------------------------
      - name: Run Qodo Scan
        run: |
          qodo scan . --format json --output qodo.json || true

      - name: Run Metis Scan
        run: |
          metis scan . --json > metis.json || true

      # -------------------------
      # Normalize Outputs
      # -------------------------
      - name: Normalize JSON
        run: |
          jq -S . qodo.json  > qodo-sorted.json  || true
          jq -S . metis.json > metis-sorted.json || true

      # -------------------------
      # Compare Results
      # -------------------------
      - name: Compare Results
        run: |
          echo "====== DIFF ======"
          diff qodo-sorted.json metis-sorted.json || true

      # -------------------------
      # Upload Artifacts
      # -------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            qodo.json
            metis.json
            qodo-sorted.json
            metis-sorted.json
