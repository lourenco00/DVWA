name: Static Scan

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq python3-pip
          pip install --upgrade pip

      - name: Install Qodo.ai CLI
        run: |
          curl -fsSL https://get.qodo.ai/install.sh | bash
          qodo --help

      - name: Install Metis CLI
        run: |
          pip install metisai
          metis --help

      - name: Run Qodo scan
        run: |
          qodo scan . --format json --output qodo.json || true

      - name: Run Metis scan
        run: |
          metis scan . --json > metis.json || true

      - name: Normalize JSON
        run: |
          jq -S . qodo.json  > qodo-sorted.json  || true
          jq -S . metis.json > metis-sorted.json || true

      - name: Compare results
        run: |
          echo "====== DIFF ======"
          diff qodo-sorted.json metis-sorted.json || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            qodo.json
            metis.json
            qodo-sorted.json
            metis-sorted.json
