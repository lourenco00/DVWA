name: Static Scan

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      QODO_API_KEY: ${{ secrets.QODO_APIKEY }}

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # -----------------------------
      # Dependencies
      # -----------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip npm git
          pip install --upgrade pip

      # -----------------------------
      # Install Qodo CLI (NPM)
      # -----------------------------
      - name: Install Qodo CLI
        run: |
          npm install -g @qodo/command
          qodo --help || true

      # -----------------------------
      # Install Metis (ARM GitHub repo)
      # -----------------------------
      - name: Install Metis CLI
        run: |
          git clone https://github.com/arm/metis.git
          cd metis
          pip install . --user
          cd ..
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          which metis || true

      # -----------------------------
      # Run Qodo Scan
      # -----------------------------
      - name: Run Qodo Scan
        run: |
          qodo scan . \
            --format json \
            --output qodo.json \
            || true

      # -----------------------------
      # Run Metis Scan
      # -----------------------------
      - name: Run Metis Scan
        run: |
          metis \
            --non-interactive \
            --command "review_code" \
            --codebase-path "." \
            --output-file "metis.json" \
            || true

      # -----------------------------
      # Normalize JSON
      # -----------------------------
      - name: Normalize JSON
        run: |
          jq -S . qodo.json  > qodo-sorted.json  || true
          jq -S . metis.json > metis-sorted.json || true

      # -----------------------------
      # Compare outputs
      # -----------------------------
      - name: Compare Results
        run: |
          echo "====== DIFF ======"
          diff qodo-sorted.json metis-sorted.json || true

      # -----------------------------
      # Upload artifacts
      # -----------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            qodo.json
            metis.json
            qodo-sorted.json
            metis-sorted.json
